## 5.1 浏览器详解一
在讨论前端，我们首先学习浏览器的内部工作原理将会有助于前端开发的理解。

### 5.1.1 基本结构
浏览器的主要组件为：
1. 用户界面 - 包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面。
2. 浏览器引擎 - 在用户界面和呈现引擎之间传送指令。
3. 呈现引擎 - 负责显示请求的内容。如果请求的内容是HTML，它就负责解析HTML和CSS内容，并将解析后的内容显示在屏幕上。
4. 网络 - 用于网络调用，比如HTTP请求。其接口与平台无关，并为所有平台提供底层实现。
5. 用户界面后端 - 用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。
6. JavaScript解释器 - 用于解析和执行JavaScript代码。
7. 数据存储 - 这是持久层，浏览器需要在硬盘上保存各种数据，例如Cookie。HTML5定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。

![5-1-browser-component](../img/5-1-browser-component.png)

### 5.1.2 呈现引擎
呈现引擎的作用是在浏览器的屏幕上显示请求的内容。默认情况下，呈现引擎可显示HTML和XML文档与图片。通过插件（或浏览器扩展程序），还可以显示其他类型的内容：例如使用PDF查看器显示PDF文档。接下来我们将介绍其主要用途：显示使用CSS格式化的HTML内容和图片。其中Safari和Chrome使用的都是WebKit。

#### 主流程

呈现引擎一开始会从网络层获取请求文档的内容，然后进行如下所示的基本流程：

![5-1-render-engine-flow](../img/5-1-render-engine-flow.png)

呈现引擎将开始解析HTML文档，并将各标记逐个转化成“内容树”上的DOM节点，同时也会解析外部CSS文件以及样式元素中的样式数据，从而构建出呈现树。呈现树包含多个带有样式（如颜色和尺寸）的矩形，这些矩形的排列顺序就是它们将在屏幕上显示的顺序。呈现树构建完毕之后，进入“布局”处理阶段，也就是为每个节点分配一个屏幕上的确切坐标。最后是绘制，呈现引擎会遍历呈现树，由用户界面后端层将每个节点绘制出来。需要说明的是，这是一个渐进的过程。为达到更好的用户体验，呈现引擎会尽快将内容显示在屏幕上，它不必等到整个HTML文档解析完毕之后，就会开始构建呈现树和设置布局，在不断接收和处理来自网络的其余内容的同时，呈现引擎会将部分内容解析并显示出来。

下图就是webkit的主流程

![5-1-webkit-flow](../img/5-1-webkit-flow.png)

#### 呈现引擎的线程
呈现引擎采用了单线程，UI操作都是在这个线程中进行的。而网络操作一把由多个并行线程执行，并行连接数是有限的（一般都是6个）。

### 5.1.3 事件循环

浏览器的主线程是事件循环。它是一个无限循环，永远处于接受处理状态，并等待事件（如布局和绘制事件）发生，并进行处理（UI系统都采用了此模型）。这是Firefox中关于主事件循环的代码：
```c
while (!mExiting)
    NS_ProcessNextEvent(thread);
```
