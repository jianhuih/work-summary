## 6.1 函数式编程
JavaScript是一门若类型的动态语言，并有C和Lisp的双重语法。有必要了解一下函数式编程。

### 6.1.1 编程分类
函数式编程是一种编程范式，我们常见的编程范式有命令式编程，函数式编程，逻辑式编程等。
命令式编程是面向计算机硬件的抽象，有变量（对应着存储单元），赋值语句（获取，存储指令），表达式（内存引用和算术运算）和控制语句（跳转指令），一句话，命令式程序就是一个冯诺依曼机的指令序列。我们熟悉的面向对象编程就是一种命令式编程。

#### 表达式和语句
这里有必要区分一下这两个概念：
表达式：可以被求值的代码
语句：一段可执行代码，不一定有值（C中大多数表达式都是有值的）

### 6.1.2 函数式编程
λ演算和图灵机是等价的。从理论上说，函数式语言并不是通过冯诺伊曼体系结构的机器上运行的，而是通过λ演算来运行的，就是通过变量替换的方式进行，变量替换为其值或表达式，函数也替换为其表达式，并根据运算符进行计算。λ演算是图灵完全的，但是大多数情况，函数式程序还是被编译成冯诺依曼机的机器语言的指令执行的。

函数式编程是面向数学的抽象，将计算描述为一种表达式求值，一句话，函数式程序就是一个表达式。函数式编程中的“函数”这个术语不是指计算机中的函数（实际上是Subroutine），而是指数学中的函数，即自变量的映射。也就是说一个函数的值仅决定于函数参数的值，不依赖其他状态。比如sqrt(x)函数计算x的平方根，只要x不变，不论什么时候调用，调用几次，值都是不变的。
下面我们将看一下函数式编程的主要特点：
#### 函数是一等对象
在函数式语言中，函数作为一等对象，可以在任何地方定义，在函数内或函数外，可以作为函数的参数和返回值，可以对函数进行组合（这一点可以大大简化GoF设计模式）。
#### 无状态性：
函数式编程的变量不同于命令式编程中的变量（存储状态的单元），而是数学中的变量，即一个值的名称。变量的值是不可变的（immutable），也就是说不允许像命令式编程那样多次给一个变量赋值。严格意义上的函数式编程意味着不使用可变的变量，赋值，循环等其他命令式控制结构进行编程（循环这种控制结构依赖于变量）。
因此在函数式语言里就只能使用递归来解决迭代问题，这使得函数式编程严重依赖递归。，算法一般都有递推（iterative）和递归（recursive）两种定义。而递归就是描述做什么，而不是怎么做（这和函数式语言契合）。
#### 匿名函数
匿名函数也称为lambda表达式，通常表示：“可以完成某件事的一块代码”。这种表达在很多场合是有用的，因为我们有时需要用函数完成某件事，但是这个函数可能只是临时性的。这个时候lambda表达式就很有用。
#### 高阶函数
在数学和计算机科学中，高阶函数就是参数为函数或返回值为函数的函数。有了高阶函数，就可以将复用的粒度降低到函数级别，相对于面向对象语言，复用的粒度更低。举例来说，假设有如下的两个函数：
```JavaScript
function sumInts(a, b) {
  if(a > b) {
    return 0;
  } else {
    return a + subInts(a + 1, b);
  }
}
function sumCubes(a, b) {
  if(a > b) {
    return 0;
  } else {
    return cube(a) + subCubes(a + 1, b);
  }
}
```
分别是求a到b之间整数之和，求a到b之间整数的立方和。这两个函数非常相似，是否可以抽象出一个共同的模式呢？我们可以定义一个高阶函数sum：
```JavaScript
function sum(func, a, b) {
  if(a > b) {
    return 0;
  } else {
    return func(a) + sum(func, a + 1, b);
  }
}
```
然后写出如下的函数即可：
```JavaScript
function id(x) {
  return x;
}
function cube(x) {
  return x * x * x;
}
function sumInts(a, b) = sum(id, a, b);
function sumCubes(a, b) = sum(cube, a, b);
```
高阶函数提供了一种函数级别上的依赖注入（或控制反转）机制，在上面的例子里，sum函数的逻辑依赖于注入进来的函数的逻辑。很多GoF设计模式都可以用高阶函数来实现，而且更为简洁。如Visitor，Strategy，Decorator等。比如Visitor模式就可以用集合类的map()或foreach()高阶函数来替代。函数式语言通常提供非常强大的集合类，提供很多高阶函数。比如，我们想对一个列表中的每个整数乘2，在命令式编程中一般需要通过循环，但是在函数式编程中，我们不需要使用循环：
```JavaScript
let nums = [1, 2, 3, 4];
let num2 = nums.map(x => x * 2);
```
这里也可以看出来函数式编程关注做什么（x*2），而不关注怎么做（使用循环控制结构）。程序员完全不关心，列表中的元素是从前到后依次计算的，还是从后到前依次计算的，是顺序计算的，还是并行进行的计算。
注：命令式编程语言也可以通过类似函数指针的方式来实现高阶函数，如C库中的sort函数接受一个compare的函数指针，以实现排序操作。
#### 柯里化
在计算机科学中，柯里化（Currying）是把接受多个参数的函数变换成接受一个单一参数(最初函数的第一个参数)的函数，并且返回接受余下的参数且返回结果的新函数的技术。
柯里化常常用于转化一个函数的接口以便于其他代码调用（GoF中的适配器模式），例如：
```JavaScript
function pow(num, i);
function square(num) = {
  return pow(num, 2);
}
```
上面的代码中pow函数被转换成square函数。在函数是语言中，函数的接口就是它的参数，柯里化通常用于减少函数参数的数量。
#### 闭包
在计算机科学中，闭包（Closure），是引用了自由变量的函数。这个被引用的自由变量将和这个函数一同存在，即使已经离开了创造它的环境也不例外。所以，有另一种说法认为闭包是由函数和与其相关的引用环境组合而成的实体。闭包在运行时可以有多个实例，不同的引用环境和相同的函数组合可以产生不同的实例。

### 6.1.3 函数式编程的优点与缺点
#### 优点
由于C语言可以使用函数指针实现高阶函数。所以函数式的最主要的好处主要是无状态性。没有可变的状态，函数就是引用透明的和无副作用。
无状态性意味着可以更好的进行并发：（多个线程之间）不共享状态，不会造成资源竞争，也就不需要用锁来保护可变状态，也就不会出现死锁。
引用透明的，函数式编程不像命令式编程那样关注执行步骤，这就为系统提供了优化函数式程序的空间，包括惰性求值和并性处理。惰性求值，是在将表达式赋值给变量（或称作绑定）时并不计算表达式的值，而在变量第一次被使用时才进行计算。这样就可以通过避免不必要的求值提升性能。
函数式编程语言一般还提供强大的模式匹配功能。在函数式编程语言中可以定义代数数据类型，通过组合已有的数据类型形成新的数据类型，如在Scala中提供case+class，代数数据类型的值可以通过模式匹配进行分析。
#### 缺点
函数式编程也有不太擅长的场合，比如处理可变状态和IO等。
